# Changes Made: 2025-11-20 - Tax Debugging & Dialog Fix

## Summary
Fixed confirmation dialog formatting issue and added comprehensive tax matching debugging to identify why 5% GST tax rate isn't matching to Evosus SalesTax_PK.

## Changes Made

### 1. Tax Code Mapping Verification ✅
**File:** `tests/get-tax-codes.php` (NEW)
- Created script to fetch actual Evosus tax codes via API
- Verified that existing tax mapping is **correct**:
  ```php
  0.00 => 1,   // Exempt
  0.05 => 2,   // GST (5%)
  0.13 => 7,   // Harmonized Sales Tax (13%)
  0.14 => 11,  // Harmonized Sales Tax (14%)
  0.15 => 8,   // Harmonized Sales Tax (15%)
  ```
- This confirms the mapping was already accurate

### 2. Enhanced Tax Matching Debug Logging ✅
**File:** `evosus-sync-for-woocommerce/includes/class-wc-evosus-integration.php`
**Lines:** 691-711

**Added detailed logging:**
```php
// Debug: Log what we're comparing
$this->logger->log_info("Tax matching - WC rate: " . round($wc_tax_rate * 100, 4) . "% (" . $wc_tax_rate . ")");

foreach ($tax_rate_map as $rate => $tax_pk) {
    $diff = abs($wc_tax_rate - (float)$rate);
    $this->logger->log_info("  Comparing to Evosus rate " . round($rate * 100, 2) . "% (" . $rate . "), diff=" . $diff . ", tax_pk=" . $tax_pk);

    if ($diff <= $tolerance) {
        // Match found - log success
    }
}
```

**What this will show:**
- The exact WooCommerce tax rate being extracted
- Each comparison step with difference calculations
- Which tax_pk should match (if any)
- Helps identify if the issue is extraction or comparison

### 3. Fixed Confirmation Dialog Formatting ✅
**File:** `evosus-sync-for-woocommerce/includes/class-evosus-order-metabox.php`
**Lines:** 342, 362

**Before:**
```php
'confirmSync' => __('Add this order to Evosus?\n\nMake sure you have reviewed the order details.', 'woocommerce-evosus-sync'),
```

**After:**
```php
'confirmSync' => __("Add this order to Evosus?\n\nMake sure you have reviewed the order details.", 'woocommerce-evosus-sync'),
```

**Why:** Changed from single quotes to double quotes so PHP interprets `\n` as actual newlines instead of literal backslash-n characters.

**Impact:** Confirmation dialogs will now show proper line breaks instead of displaying `\n\n` literally.

## Testing Required

### 1. Test Confirmation Dialogs
- Go to any WooCommerce order in WordPress admin
- Click "Add to Evosus" button
- **Expected:** Confirmation dialog should show:
  ```
  Add this order to Evosus?

  Make sure you have reviewed the order details.
  ```
- **Should NOT show:** `\n\n` literally

### 2. Test Tax Matching Debug Logs
- Process an order with 5% GST (BC tax rate)
- Check WooCommerce logs: WooCommerce → Status → Logs → evosus-sync
- **Expected to see:**
  ```
  Tax matching - WC rate: 5% (0.05)
    Comparing to Evosus rate 0% (0), diff=0.05, tax_pk=1
    Comparing to Evosus rate 5% (0.05), diff=0, tax_pk=2
  ✅ Matched WooCommerce tax rate 5% (GST) to Evosus SalesTax_PK 2
  ```

**If it's NOT matching:**
The debug logs will show:
1. What tax rate WooCommerce is extracting
2. What each comparison is calculating
3. Why the match is failing (difference too large, wrong extraction, etc.)

## Next Steps

1. **Upload plugin to WordPress** with these changes
2. **Test confirmation dialog** - should show proper newlines now
3. **Process test order with 5% GST** and check logs
4. **Review debug output** to identify exact tax matching issue
5. **Fix tax extraction** based on debug findings (if needed)

## Files Modified

```
evosus-sync-for-woocommerce/includes/class-wc-evosus-integration.php
evosus-sync-for-woocommerce/includes/class-evosus-order-metabox.php
tests/get-tax-codes.php (NEW)
tests/debug-wc-tax.php (NEW)
```

## Verification Commands

```bash
# Verify tax mapping is correct
php tests/get-tax-codes.php

# Test tax extraction logic
php tests/debug-wc-tax.php
```
